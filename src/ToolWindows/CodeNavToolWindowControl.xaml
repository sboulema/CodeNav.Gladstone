<DataTemplate xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
              xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
              xmlns:vs="http://schemas.microsoft.com/visualstudio/extensibility/2022/xaml"
              xmlns:styles="clr-namespace:Microsoft.VisualStudio.Shell;assembly=Microsoft.VisualStudio.Shell.15.0"
              xmlns:colors="clr-namespace:Microsoft.VisualStudio.PlatformUI;assembly=Microsoft.VisualStudio.Shell.15.0">

    <DataTemplate.Resources>
        <!-- PlusMinusExpander Styles -->
        <Style x:Key="ExpanderHeaderFocusVisual">
            <Setter Property="Control.Template">
                <Setter.Value>
                    <ControlTemplate>
                        <Border>
                            <Rectangle Margin="0" SnapsToDevicePixels="true" Stroke="Black" StrokeThickness="1" StrokeDashArray="1 2"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="ExpanderDownHeaderStyle" TargetType="ToggleButton">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Padding="{TemplateBinding Padding}">
                            <vs:Image Source="KnownMonikers.Expand" x:Name="arrow" Width="16" Height="16" Visibility="{Binding Path=HasMembersVisibility}" />
                        </Border>

                        <ControlTemplate.Triggers>
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding Path=IsChecked, RelativeSource={RelativeSource Self}}" Value="True"/>
                                    <Condition Binding="{Binding Path=DataContext.HasMembersVisibility, RelativeSource={RelativeSource Self}}" Value="Visible"/>
                                </MultiDataTrigger.Conditions>
                                <Setter Property="Source" TargetName="arrow" Value="KnownMonikers.Collapse" />
                            </MultiDataTrigger>
                            <Trigger Property="IsChecked" Value="False">
                                <Setter Property="Source" TargetName="arrow" Value="KnownMonikers.Expand" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="Expander">
            <Setter Property="Foreground" Value="{DynamicResource {x:Static colors:EnvironmentColors.ToolWindowTextBrushKey}}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Expander">
                        <Border x:Name="ExpanderBorder" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" Background="{TemplateBinding Background}" CornerRadius="0" SnapsToDevicePixels="true">
                            <StackPanel Orientation="Vertical">
                                <Grid Background="Transparent" SnapsToDevicePixels="False" Margin="0,0,4,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="17"/>
                                    </Grid.ColumnDefinitions>

                                    <Border BorderThickness="0" x:Name="ExpanderHeaderBorder">
                                        <Border.BorderBrush>
                                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                <GradientStop Color="DarkGray" Offset="0.0" />
                                                <GradientStop Color="LightGray" Offset="0.5" />
                                                <GradientStop Color="Transparent" Offset="1" />
                                            </LinearGradientBrush>
                                        </Border.BorderBrush>
                                        <Button Command="{Binding Path=ClickItemCommand}" 
                                            CommandParameter="{Binding StartLinePosition}"
                                            ContentTemplate="{TemplateBinding HeaderTemplate}"
                                            ContentTemplateSelector="{TemplateBinding HeaderTemplateSelector}"
                                            Content="{TemplateBinding Header}"
                                            Padding="{TemplateBinding Padding}"
                                            Background="Transparent"
                                            Foreground="{TemplateBinding Foreground}"
                                            FontWeight="{TemplateBinding FontWeight}"
                                            FontStyle="{TemplateBinding FontStyle}"
                                            FontStretch="{TemplateBinding FontStretch}"
                                            FontSize="{TemplateBinding FontSize}"
                                            FontFamily="{TemplateBinding FontFamily}"
                                            HorizontalContentAlignment="Left"
                                            HorizontalAlignment="Stretch"
                                            VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                            FocusVisualStyle="{StaticResource ExpanderHeaderFocusVisual}"
                                            DockPanel.Dock="Top"
                                            BorderThickness="0"
                                            Margin="4,0,0,0" />
                                    </Border>

                                    <ToggleButton 
                                        Grid.Column="1" 
                                        x:Name="HeaderSite" 
                                        IsChecked="{Binding IsExpanded, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}" 
                                        Margin="1" 
                                        MinWidth="0" 
                                        MinHeight="0" 
                                        Style="{StaticResource ExpanderDownHeaderStyle}" 
                                        VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}" />
                                </Grid>
                                <ContentPresenter 
                                    x:Name="ExpandSite" 
                                    DockPanel.Dock="Bottom" 
                                    Focusable="false" 
                                    HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" 
                                    Margin="{TemplateBinding Padding}" 
                                    Visibility="Collapsed" />
                            </StackPanel>
                        </Border>
                        <ControlTemplate.Triggers>
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding Path=IsExpanded, RelativeSource={RelativeSource Self}}" Value="True"/>
                                    <Condition Binding="{Binding Path=DataContext.HasMembersVisibility, RelativeSource={RelativeSource Self}}" Value="Visible"/>
                                </MultiDataTrigger.Conditions>
                                <Setter Property="Visibility" TargetName="ExpandSite" Value="Visible"/>
                                <Setter Property="BorderThickness" TargetName="ExpanderHeaderBorder" Value="0,0,0,1" />
                            </MultiDataTrigger>
                            <Trigger Property="IsEnabled" Value="false">
                                <Setter Property="Foreground" Value="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"/>
                            </Trigger>
                            <Trigger Property="IsExpanded" Value="False">
                                <Setter Property="BorderThickness" TargetName="ExpanderHeaderBorder" Value="0" />
                            </Trigger>
                            <DataTrigger Binding="{Binding Path=DataContext.IsHighlighted, RelativeSource={RelativeSource Self}}" Value="False">
                                <Setter Property="BorderBrush" TargetName="ExpanderBorder" Value="DarkGray" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Path=DataContext.IsHighlighted, RelativeSource={RelativeSource Self}}" Value="True">
                                <Setter Property="BorderBrush" TargetName="ExpanderBorder" Value="{DynamicResource {x:Static styles:VsBrushes.FileTabSelectedBorderKey}}" />
                            </DataTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <!-- Highlighting Styles --> 
        <Style x:Key="HighlightNameStyle" TargetType="Run">
            <Style.Triggers>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding Path=DataContext.IsHighlighted, RelativeSource={RelativeSource Self}}" Value="True"/>
                        <Condition Binding="{Binding Path=DataContext.DataTemplateType, RelativeSource={RelativeSource Self}}" Value=""/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="FontWeight" Value="Bold" />
                </MultiDataTrigger>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding Path=DataContext.IsHighlighted, RelativeSource={RelativeSource Self}}" Value="False"/>
                        <Condition Binding="{Binding Path=DataContext.DataTemplateType, RelativeSource={RelativeSource Self}}" Value=""/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="FontWeight" Value="Regular" />
                </MultiDataTrigger>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding Path=DataContext.IsHighlighted, RelativeSource={RelativeSource Self}}" Value="False"/>
                        <Condition Binding="{Binding Path=DataContext.DataTemplateType, RelativeSource={RelativeSource Self}}" Value="Region"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="FontWeight" Value="SemiBold" />
                </MultiDataTrigger>
                <DataTrigger Binding="{Binding Path=DataContext.IsHighlighted, RelativeSource={RelativeSource Self}}" Value="True">
                    <Setter Property="Foreground" Value="{DynamicResource {x:Static styles:VsBrushes.FileTabSelectedBorderKey}}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding Path=DataContext.IsHighlighted, RelativeSource={RelativeSource Self}}" Value="False">
                    <Setter Property="Foreground" Value="{DynamicResource {x:Static styles:VsBrushes.ToolWindowTextKey}}" />
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <!-- CodeItem Styles -->
        <Style TargetType="ContentControl">
            <!-- CodeItem Template -->
            <Setter Property="ContentTemplate">
                <Setter.Value>
                    <DataTemplate>
                        <Button Command="{Binding Path=ClickItemCommand}"
                            CommandParameter="{Binding StartLine}"
                            ToolTip="{Binding Tooltip}"
                            Visibility="{Binding Visibility}"
                            ContextMenu="{DynamicResource ItemContextMenu}"
                            Background="Transparent"
                            BorderThickness="0" 
                            HorizontalContentAlignment="Stretch"
                            HorizontalAlignment="Stretch"
                            Margin="-3, 0"
                            Padding="3, 3">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <Grid Margin="0,0,3,0" Width="16" Height="16">
                                    <vs:Image Source="{Binding Moniker}" />
                                    <vs:Image Source="{Binding OverlayMoniker}" Width="8" Height="8" HorizontalAlignment="Right" VerticalAlignment="Bottom" />
                                </Grid>

                                <TextBlock Grid.Column="1">
                                    <Run Text="{Binding Name}"       
                                         Style="{StaticResource HighlightNameStyle}" />
                                    <Run Text="{Binding ReturnType}"
                                         Foreground="DarkGray" />
                                    <Run Text="{Binding Parameters}"
                                         Foreground="DarkGray" />
                                </TextBlock>

                                <vs:Image 
                                    Grid.Column="2"
                                    Source="KnownMonikers.History"
                                    Margin="3,0,0,0"
                                    Width="10"
                                    Height="10"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Visibility="{Binding StatusMonikerVisibility}" 
								    Grayscale="{Binding StatusGrayscale}"
                                    Opacity="{Binding StatusOpacity}" />
                            </Grid>
                        </Button>
                    </DataTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <!-- Namespace Template -->
                <DataTrigger Binding="{Binding DataTemplateType}" Value="Namespace">
                    <Setter Property="ContentTemplate">
                        <Setter.Value>
                            <DataTemplate>
                                <StackPanel>
                                    <Expander
                                        IsExpanded="{Binding IsExpanded}"
                                        ToolTip="{Binding Tooltip}"
                                        HorizontalAlignment="Stretch">
                                        <Expander.Header>
                                            <StackPanel Orientation="Horizontal">
                                                <vs:Image Source="{Binding Moniker}" Width="16" Height="16" Margin="0,0,3,0" />
                                                <TextBlock>
                                                    <Run Text="{Binding Name}" 
                                                         Style="{StaticResource HighlightNameStyle}"/>
                                                    <Run Text="{Binding Parameters}" 
                                                         Foreground="DarkGray" />
                                                </TextBlock>
                                            </StackPanel>
                                        </Expander.Header>
                                        <ItemsControl 
                                            ItemsSource="{Binding Members}"
                                            Margin="4"
                                            VirtualizingPanel.IsVirtualizing="True"
                                            VirtualizingPanel.VirtualizationMode="Recycling"
                                            ScrollViewer.CanContentScroll="False">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <VirtualizingStackPanel />
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <ContentControl Content="{Binding}">
                                                    </ContentControl>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                            <ItemsControl.ItemContainerStyle>
                                                <Style>
                                                    <Setter Property="FrameworkElement.Visibility" Value="{Binding Visibility}"/>
                                                </Style>
                                            </ItemsControl.ItemContainerStyle>
                                        </ItemsControl>
                                    </Expander>
                                </StackPanel>
                            </DataTemplate>
                        </Setter.Value>
                    </Setter>
                </DataTrigger>
                <!-- Class Template -->
                <DataTrigger Binding="{Binding DataTemplateType}" Value="Class">
                    <Setter Property="ContentTemplate">
                        <Setter.Value>
                            <DataTemplate>
                                <StackPanel>
                                    <Expander
                                        IsExpanded="{Binding IsExpanded}"
                                        ToolTip="{Binding Tooltip}"
                                        HorizontalAlignment="Stretch">
                                        <Expander.Header>
                                            <StackPanel Orientation="Horizontal">
                                                <vs:Image Source="{Binding Moniker}" Width="16" Height="16" Margin="0,0,3,0" />
                                                <TextBlock>
                                                    <Run Text="{Binding Name}" 
                                                         Style="{StaticResource HighlightNameStyle}" />
                                                    <Run Text="{Binding Parameters}" 
                                                         Foreground="DarkGray" />
                                                </TextBlock>
                                            </StackPanel>
                                        </Expander.Header>
                                        <ItemsControl 
                                            ItemsSource="{Binding Members}"
                                            Margin="4"
                                            VirtualizingPanel.IsVirtualizing="True"
                                            VirtualizingPanel.VirtualizationMode="Recycling"
                                            ScrollViewer.CanContentScroll="False">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <VirtualizingStackPanel />
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <ContentControl Content="{Binding}">
                                                    </ContentControl>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                            <ItemsControl.ItemContainerStyle>
                                                <Style>
                                                    <Setter Property="FrameworkElement.Visibility" Value="{Binding Visibility}"/>
                                                </Style>
                                            </ItemsControl.ItemContainerStyle>
                                        </ItemsControl>
                                    </Expander>
                                </StackPanel>
                            </DataTemplate>
                        </Setter.Value>
                    </Setter>
                </DataTrigger>
                <!-- Region Template -->
                <DataTrigger Binding="{Binding DataTemplateType}" Value="Region">
                    <Setter Property="ContentTemplate">
                        <Setter.Value>
                            <DataTemplate>
                                <StackPanel>
                                    <Expander
                                        IsExpanded="{Binding IsExpanded}"
                                        ToolTip="{Binding Tooltip}"
                                        HorizontalAlignment="Stretch">
                                        <Expander.Header>
                                            <TextBlock
                                                Text="{Binding Name}"
                                                FontWeight="SemiBold" />
                                        </Expander.Header>
                                        <!--<ItemsControl 
                                            ItemsSource="{Binding Members}"
                                            Margin="4"
                                            VirtualizingPanel.IsVirtualizing="True"
                                            VirtualizingPanel.VirtualizationMode="Recycling"
                                            ScrollViewer.CanContentScroll="False">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <VirtualizingStackPanel />
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <ContentControl Content="{Binding}">
                                                    </ContentControl>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                            <ItemsControl.ItemContainerStyle>
                                                <Style>
                                                    <Setter Property="FrameworkElement.Visibility" Value="{Binding Visibility}"/>
                                                </Style>
                                            </ItemsControl.ItemContainerStyle>
                                        </ItemsControl>-->
                                    </Expander>
                                </StackPanel>
                            </DataTemplate>
                        </Setter.Value>
                    </Setter>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </DataTemplate.Resources>
    
    <Border Background="{DynamicResource {x:Static colors:EnvironmentColors.ToolWindowBackgroundBrushKey}}"
            TextElement.Foreground="{DynamicResource {x:Static colors:EnvironmentColors.ToolWindowTextBrushKey}}"
            Padding="5">

        <Grid Margin="4">
            <Grid.RowDefinitions>
                <RowDefinition Height="auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Filter Toolbar -->
            <Grid Visibility="{Binding ShowFilterToolbarVisibility}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Grid>
                    <TextBox x:Name="FilterTextBox"
                         Padding="3"
                         ToolTip="Type words to search for" 
                         Text="{Binding FilterText, Mode=TwoWay}" />
                    <TextBlock
                        IsHitTestVisible="False"
                        Text="Search CodeNav"
                        VerticalAlignment="Center"
                        HorizontalAlignment="Left"
                        Margin="10,0,0,0"
                        Padding="0,0,10,0"
                        Foreground="DarkGray">
                        <TextBlock.Style>
                            <Style TargetType="{x:Type TextBlock}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Text, ElementName=FilterTextBox}" Value="">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </Grid>

                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button
                        Command="{Binding Path=ClearFilterTextCommand}"
                        ToolTip="Click to clear text filter contents">
                        <Button.Template>
                            <ControlTemplate>
                                <vs:Image Source="KnownMonikers.DeleteFilter" Width="16" Height="16" />
                            </ControlTemplate>
                        </Button.Template>
                        <Button.Style>
                            <Style TargetType="{x:Type Button}">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Text, ElementName=FilterTextBox}" Value="">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                    <Button
                        Command="{Binding Path=OpenFilterDialogCommand}"
                        ToolTip="Click to filter by item kind">
                        <Button.Template>
                            <ControlTemplate>
                                <vs:Image Source="KnownMonikers.Filter" Width="16" Height="16" />
                            </ControlTemplate>
                        </Button.Template>
                    </Button>
                </StackPanel>
            </Grid>
            
            <!-- Code items -->
            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                <ItemsControl x:Name="CodeItemsControl"
                ItemsSource="{Binding CodeDocument}"
                VirtualizingPanel.IsVirtualizing="True"
                VirtualizingPanel.VirtualizationMode="Recycling"
                ScrollViewer.CanContentScroll="True">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <VirtualizingStackPanel />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <ContentControl Content="{Binding}">
                            </ContentControl>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                    <ItemsControl.ItemContainerStyle>
                        <Style>
                            <Setter Property="FrameworkElement.Visibility" Value="{Binding Visibility}"/>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                </ItemsControl>
            </ScrollViewer>
        </Grid>

    </Border>
</DataTemplate>
